<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hino Tactical Radio</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Share Tech Mono', monospace; 
            background: radial-gradient(circle at center, #2c3e50, #000); 
            margin: 0; padding: 0;
            height: 100vh; 
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
        }

        /* --- LE BOITIER (Le corps du Talkie) --- */
        .walkie-case {
            width: 300px;
            height: 580px;
            background: linear-gradient(145deg, #333, #1a1a1a);
            border-radius: 40px;
            box-shadow: 
                20px 20px 60px #0b0b0b, 
                -5px -5px 20px #444,
                inset 0 0 20px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; align-items: center;
            padding: 30px 20px;
            position: relative;
            border: 4px solid #111;
        }

        /* L'Antenne */
        .antenna {
            position: absolute; top: -60px; right: 40px;
            width: 20px; height: 70px;
            background: #222;
            border-radius: 10px 10px 0 0;
            z-index: -1;
            border: 2px solid #000;
        }

        /* --- L'ECRAN LCD --- */
        .screen-container {
            width: 100%;
            background: #111;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #555;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px #000;
        }

        .lcd-screen {
            background: #3e4a38; /* Couleur verte LCD éteint */
            height: 80px;
            border-radius: 5px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #1a2416; /* Texte éteint */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        /* Quand l'écran est allumé/actif */
        .lcd-active {
            background: #80c268; /* Vert allumé */
            color: #003300;
            text-shadow: 0 0 2px rgba(0,50,0,0.5);
            box-shadow: 0 0 15px #80c268;
        }

        .freq-display { font-size: 32px; letter-spacing: 2px; }
        .status-line { font-size: 14px; margin-top: 5px; text-transform: uppercase;}

        /* --- INPUTS CACHÉS DANS LE DESIGN --- */
        .inputs-row {
            display: flex; gap: 10px; width: 100%; margin-bottom: 15px;
        }
        .retro-input {
            background: #222; border: 1px solid #444; color: #aaa;
            padding: 8px; border-radius: 5px; width: 100%;
            font-family: inherit; text-align: center; font-size: 14px;
        }
        .retro-input:focus { outline: none; border-color: #80c268; color: #fff; }

        /* --- GRILLE HAUT PARLEUR --- */
        .speaker-grille {
            width: 100%; height: 100px;
            background-image: radial-gradient(#000 20%, transparent 20%);
            background-size: 10px 10px; /* Les trous de la grille */
            margin-bottom: 30px;
            opacity: 0.6;
            border-radius: 10px;
            border: 1px solid #222;
        }

        /* --- BOUTON PTT (Push To Talk) --- */
        .ptt-container {
            position: relative;
            width: 140px; height: 140px;
        }

        #ptt-btn {
            width: 100%; height: 100%;
            border-radius: 50%;
            border: none;
            background: linear-gradient(145deg, #a12b2b, #751f1f);
            box-shadow: 
                5px 5px 15px #0b0b0b, 
                -5px -5px 15px #444;
            color: #ddd;
            font-family: inherit; font-weight: bold; font-size: 18px;
            cursor: pointer;
            transition: all 0.1s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            border: 4px solid #441111;
        }

        #ptt-btn:active, .btn-pressed {
            transform: scale(0.95);
            background: linear-gradient(145deg, #751f1f, #a12b2b);
            box-shadow: inset 5px 5px 10px #3d0d0d, inset -5px -5px 10px #912b2b;
            color: #ffaaaa;
            border-color: #ff0000;
        }

        /* --- LED D'ÉTAT --- */
        .led {
            width: 15px; height: 15px;
            background: #330000;
            border-radius: 50%;
            position: absolute; top: 20px; left: 20px;
            box-shadow: inset 0 0 2px #000;
            border: 1px solid #000;
            transition: 0.2s;
        }
        .led.tx { background: #ff0000; box-shadow: 0 0 10px #ff0000; } /* Transmission (Rouge) */
        .led.rx { background: #00ff00; box-shadow: 0 0 10px #00ff00; } /* Réception (Vert) */

        /* Texte explicatif en bas */
        .brand {
            margin-top: auto; color: #555; font-size: 12px; letter-spacing: 1px;
            border-top: 1px solid #333; width: 100%; text-align: center; padding-top: 10px;
        }

        /* Mobile tweaks */
        @media (max-width: 400px) {
            .walkie-case { width: 90%; height: 90vh; border-radius: 30px;}
        }
    </style>
</head>
<body>

    <div class="walkie-case">
        <div class="antenna"></div>
        <div class="led" id="led-light"></div>

        <div class="screen-container">
            <div class="lcd-screen" id="lcd">
                <div class="freq-display" id="freq-text">102.5</div>
                <div class="status-line" id="lcd-status">STANDBY</div>
            </div>
        </div>

        <div class="inputs-row">
            <input type="text" class="retro-input" id="username" placeholder="Pseudo" value="Hino-01">
            <input type="text" class="retro-input" id="frequency" value="102.5" placeholder="MHz">
            <button onclick="changerFrequence()" class="retro-input" style="width: 50px; background:#444; cursor:pointer;">SET</button>
        </div>

        <div class="speaker-grille"></div>

        <div class="ptt-container">
            <button id="ptt-btn">PUSH<br>TO TALK</button>
        </div>

        <div class="brand">HINO SYSTEM // MODEL X-1</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentFreq = "102.5";
        let mediaRecorder;
        let audioChunks = [];
        
        // Elements UI
        const btn = document.getElementById('ptt-btn');
        const lcd = document.getElementById('lcd');
        const lcdStatus = document.getElementById('lcd-status');
        const freqText = document.getElementById('freq-text');
        const led = document.getElementById('led-light');

        // Init
        socket.emit('join-frequency', currentFreq);
        lcd.classList.add('lcd-active'); // Allumer l'écran

        function changerFrequence() {
            currentFreq = document.getElementById('frequency').value;
            freqText.innerText = currentFreq;
            socket.emit('join-frequency', currentFreq);
            
            // Petit effet clignotement écran
            lcd.classList.remove('lcd-active');
            setTimeout(() => lcd.classList.add('lcd-active'), 200);
            lcdStatus.innerText = "TUNED";
        }

        // --- MICROPHONE ---
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks);
                    const myName = document.getElementById('username').value;
                    socket.emit('voice-data', { frequency: currentFreq, audioBlob: audioBlob, username: myName });
                    audioChunks = [];
                });
            })
            .catch(err => lcdStatus.innerText = "ERR: MIC");

        // --- GESTION DU BOUTON (TX) ---
        const startTalk = (e) => {
            if(e.cancelable) e.preventDefault();
            if (mediaRecorder && mediaRecorder.state === "inactive") {
                mediaRecorder.start();
                btn.classList.add('btn-pressed');
                led.className = "led tx"; // LED Rouge
                lcdStatus.innerText = "TRANSMITTING...";
                lcd.style.background = "#ffaaaa"; // Ecran un peu rouge
            }
        };

        const stopTalk = (e) => {
            if(e.cancelable) e.preventDefault();
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                btn.classList.remove('btn-pressed');
                led.className = "led"; // LED Eteinte
                lcdStatus.innerText = "STANDBY";
                lcd.style.background = ""; // Reset couleur écran
            }
        };

        btn.addEventListener('mousedown', startTalk);
        btn.addEventListener('touchstart', startTalk, {passive: false});
        btn.addEventListener('mouseup', stopTalk);
        btn.addEventListener('touchend', stopTalk, {passive: false});
        btn.addEventListener('mouseleave', stopTalk);

        // --- RECEPTION AUDIO (RX) ---
        socket.on('receive-voice', (data) => {
            const audioBlob = new Blob([data.audioBlob]);
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            // UI Update
            lcdStatus.innerText = "RX: " + data.username;
            led.className = "led rx"; // LED Verte
            lcd.style.background = "#80c268"; // Vert intense
            
            audio.play().catch(e => console.log(e));

            audio.onended = () => {
                led.className = "led";
                lcdStatus.innerText = "STANDBY";
            };
        });
    </script>
</body>
</html>